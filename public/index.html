<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰</title>
    <link href="style.css" rel="stylesheet" />
  </head>

  <body>
    <div class="status-info">ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span id="loginUser"></span> ï¼ˆ<span id="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>ï¼‰</div>

    <section>
      <div id="create">
        <form>
          <div class="row"><label>åå‰ï¼š</label><input name="name" /></div>
          <div class="row">
            <label>ã‚¿ã‚¤ãƒ—ï¼š</label>
            <div class="radio">
              <input type="radio" name="type" value="æ°´" />æ°´ &nbsp; <input type="radio" name="type" value="ç‚" />ç‚
              &nbsp; <input type="radio" name="type" value="è‰" />è‰ &nbsp;
              <input type="radio" name="type" value="æ°·" />æ°· &nbsp; <input type="radio" name="type" value="æ‚ª" />æ‚ª
            </div>
          </div>
          <div class="row"><label>ãƒ¬ãƒ™ãƒ«ï¼š</label><input type="number" name="level" /></div>
          <div class="row"><label>æ„›ç§°ï¼š</label><input name="nickname" /></div>
          <div class="cap"><button type="submit">ä½œæˆ</button></div>
        </form>
      </div>

      <div style="text-align: right; margin: 10px 0">
        <button id="refreshBtn" style="padding: 5px 15px; cursor: pointer">ğŸ”„ æœ€æ–°ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€</button>
      </div>

      <div id="display">
        <table>
          <caption>
            ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§
          </caption>
          <thead>
            <tr>
              <th>ID</th>
              <th>åå‰</th>
              <th>ã‚¿ã‚¤ãƒ—</th>
              <th>ãƒ¬ãƒ™ãƒ«</th>
              <th>æ„›ç§°</th>
              <th>æŠ•ç¨¿è€…</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div id="deleteAll">
      <button>ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
    </div>
  </body>

  <script>
    /* ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§ï¼ˆtableè¦ç´ ï¼‰ã‚’æ›´æ–°  */
    async function updateTable() {
      const tbody = document.querySelector('#display tbody');

      // æ›´æ–°ä¸­ã ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«ä¸€æ—¦æ–‡å­—ã‚’å‡ºã™ï¼ˆä»»æ„ï¼‰
      // tbody.innerHTML = '<tr><td colspan="6">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';

      // ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
      const res = await fetch('/api/pokemons');

      // ä¸­èº«ã‚’ã‚¯ãƒªã‚¢
      tbody.innerHTML = '';

      if (!res.ok) return;
      const list = await res.json();

      // tbodyè¦ç´ ã‚’æ›´æ–°
      for (const record of list) {
        const { id, name, type, level, nickname, author } = record;
        const fields = [id, name, type, level, nickname, author];

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
        const tr = document.createElement('tr');
        tbody.appendChild(tr);
        for (const entry of fields) {
          const td = document.createElement('td');
          td.textContent = entry;
          tr.appendChild(td);
        }
      }
    }

    /* â˜…è¿½åŠ ï¼šæ›´æ–°ãƒœã‚¿ãƒ³ã®å‹•ä½œ */
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      await updateTable();
      // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã“ã¨ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ã¡ã‚‡ã£ã¨ãƒ­ã‚°ã‚’å‡ºã™ï¼ˆãªãã¦ã‚‚OKï¼‰
      console.log('ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    });

    /* ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª */
    document.addEventListener('DOMContentLoaded', async () => {
      // ç¢ºèª
      const res = await fetch('/api/check');

      // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãŸã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º
      if (res.ok) {
        const data = await res.json();
        const loginUser = document.getElementById('loginUser');
        loginUser.textContent = `${data.username} ã•ã‚“`;
        updateTable(); //  ä¸€è¦§è¡¨ç¤º
      }
      // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°1ç§’å¾Œã« login.html ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      else {
        document.body.innerHTML = '<h1>ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™</h1>';
        setTimeout(function () {
          location.href = 'login.html';
        }, 1000); // 1ç§’å¾Œ
      }
    });

    /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ */
    document.getElementById('logout').addEventListener('click', logout);
    async function logout() {
      const res = await fetch('/api/logout', { method: 'POST' });
      if (res.ok) location.href = 'login.html';
    }

    /*** ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ ***/
    document.querySelector('#create button').addEventListener('click', createData);
    async function createData(ev) {
      // formé€ä¿¡ã‚’åœæ­¢
      ev.preventDefault();

      // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã®å–å¾— â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒ‡ã‚£ã®ä½œæˆ
      const form = document.querySelector('#create form');
      const record = {
        name: form.name.value,
        type: form.type.value,
        level: form.level.value,
        nickname: form.nickname.value
      };
      for (const key in record) {
        if (!record[key]) {
          window.alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
      }
      const body = new FormData();
      body.append('record', JSON.stringify(record));

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      form.name.value = '';
      form.type.value = false;
      form.level.value = '';
      form.nickname.value = '';

      // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const res = await fetch('/api/pokemons', {
        method: 'POST',
        body: body
      });

      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç¢ºèª
      const created = await res.json();
      if (res.ok) {
        console.log(JSON.stringify(created, null, 2));
      } else {
        console.warn(created.message);
        return;
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
      updateTable();
    }

    /* ãƒªã‚½ãƒ¼ã‚¹ã‚’ã™ã¹ã¦å‰Šé™¤ */
    document.querySelector('#deleteAll button').addEventListener('click', deleteDataAll);
    async function deleteDataAll() {
      const res = await fetch('/api/pokemons', { method: 'DELETE' });
      if (res.ok) {
        updateTable();
      } else {
        console.warn('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
  </script>
</html>
