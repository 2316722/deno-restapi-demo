<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>„Åø„Çì„Å™„ÅÆÂ•Ω„Åç„Å™Ëâ≤</title>
  <style>
    body {
      padding: 20px;
      font-family: sans-serif;
      max-width: 800px;
      margin: 0 auto;
    }
    .ranking-area {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .rank-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .rank-label {
      width: 80px;
      font-weight: bold;
    }
    .rank-bar-bg {
      flex-grow: 1;
      background-color: #ddd;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-right: 10px;
    }
    .rank-bar {
      height: 100%;
      text-align: right;
      padding-right: 5px;
      color: white;
      font-size: 12px;
      line-height: 20px;
      transition: width 0.5s;
    }
    .rank-count {
      width: 40px;
      text-align: right;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #f0f0f0;
    }
    .color-box {
      width: 30px;
      height: 30px;
      border: 1px solid #999;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>„Åø„Çì„Å™„ÅÆÂ•Ω„Åç„Å™Ëâ≤„É©„É≥„Ç≠„É≥„Ç∞</h1>
  <p><a href="index.html">‚Üê ÂÖ•ÂäõÁîªÈù¢„Å´Êàª„Çã</a></p>

  <div class="ranking-area">
    <h2>üé® Ëâ≤Á≥ªÁµ±Âà• ‰∫∫Ê∞ó„É©„É≥„Ç≠„É≥„Ç∞</h2>
    <div id="rankingList">ÈõÜË®à‰∏≠...</div>
  </div>

  <h2>„Åô„Åπ„Å¶„ÅÆÂõûÁ≠î‰∏ÄË¶ß</h2>
  <table>
    <thead>
      <tr>
        <th>„É¶„Éº„Ç∂„Éº</th>
        <th>Â•Ω„Åç„Å™Ëâ≤</th>
        <th>Âà§ÂÆö</th>
        <th>„Ç≥„É°„É≥„Éà</th>
        <th>Êó•ÊôÇ</th>
      </tr>
    </thead>
    <tbody id="listBody"></tbody>
  </table>

  <script>
    const CATEGORIES = {
      RED: 'Ëµ§Á≥ª', ORANGE: '„Ç™„É¨„É≥„Ç∏Á≥ª', YELLOW: 'ÈªÑËâ≤Á≥ª', GREEN: 'Á∑ëÁ≥ª',
      CYAN: 'Ê∞¥Ëâ≤Á≥ª', BLUE: 'ÈùíÁ≥ª', PURPLE: 'Á¥´Á≥ª', PINK: '„Éî„É≥„ÇØÁ≥ª',
      BROWN: 'Ëå∂Ëâ≤Á≥ª', GRAY: 'ÁôΩ„Éª„Ç∞„É¨„ÉºÁ≥ª', BLACK: 'ÈªíÁ≥ª'
    };

    const CATEGORY_CSS = {
      [CATEGORIES.RED]: '#ff4d4d', [CATEGORIES.ORANGE]: '#ffa500', [CATEGORIES.YELLOW]: '#ffd700',
      [CATEGORIES.GREEN]: '#4caf50', [CATEGORIES.CYAN]: '#00bcd4', [CATEGORIES.BLUE]: '#2196f3',
      [CATEGORIES.PURPLE]: '#9c27b0', [CATEGORIES.PINK]: '#e91e63', [CATEGORIES.BROWN]: '#795548',
      [CATEGORIES.GRAY]: '#9e9e9e', [CATEGORIES.BLACK]: '#333333'
    };

    function getColorCategory(hex) {
      hex = hex.replace('#', '');
      const r = parseInt(hex.substring(0, 2), 16) / 255;
      const g = parseInt(hex.substring(2, 4), 16) / 255;
      const b = parseInt(hex.substring(4, 6), 16) / 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      const v = max, d = max - min;
      const s = max === 0 ? 0 : d / max;
      let h = 0;
      if (max !== min) {
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      const hDeg = h * 360, sPct = s * 100, vPct = v * 100;
      if (vPct < 35) return { name: CATEGORIES.BLACK, css: CATEGORY_CSS[CATEGORIES.BLACK] };
      if (sPct < 15) return { name: CATEGORIES.GRAY, css: CATEGORY_CSS[CATEGORIES.GRAY] };
      if (hDeg >= 10 && hDeg < 45 && vPct < 50) return { name: CATEGORIES.BROWN, css: CATEGORY_CSS[CATEGORIES.BROWN] };
      let name = '';
      if (hDeg < 20 || hDeg >= 355) name = CATEGORIES.RED;
      else if (hDeg < 45) name = CATEGORIES.ORANGE;
      else if (hDeg < 70) name = CATEGORIES.YELLOW;
      else if (hDeg < 160) name = CATEGORIES.GREEN;
      else if (hDeg < 200) name = CATEGORIES.CYAN;
      else if (hDeg < 260) name = CATEGORIES.BLUE;
      else if (hDeg < 300) name = CATEGORIES.PURPLE;
      else name = CATEGORIES.PINK;
      return { name, css: CATEGORY_CSS[name] };
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const checkRes = await fetch('/api/check');
      if (!checkRes.ok) { location.href = 'login.html'; return; }

      const res = await fetch('/api/colors');
      if (res.ok) {
        const list = await res.json();
        
        // 1. „Ç´„É©„Éº„Ç≥„Éº„Éâ„Åî„Å®„ÅÆÂá∫ÁèæÂõûÊï∞„ÇíÈõÜË®à
        const hexCounts = {};
        list.forEach(item => {
          const hex = item.color.toUpperCase();
          hexCounts[hex] = (hexCounts[hex] || 0) + 1;
        });

        // 2. Á≥ªÁµ±Âà•„ÅÆÈõÜË®à
        const counts = {};
        Object.values(CATEGORIES).forEach(name => counts[name] = 0);

        const tbody = document.getElementById('listBody');
        tbody.innerHTML = '';

        // 3. „ÉÜ„Éº„Éñ„É´„ÅÆÊèèÁîª„Å®Á≥ªÁµ±Âà•„Ç´„Ç¶„É≥„Éà
        list.forEach((item) => {
          const category = getColorCategory(item.color);
          if (counts[category.name] !== undefined) counts[category.name]++;

          const sameColorCount = hexCounts[item.color.toUpperCase()];
          const date = new Date(item.createdAt).toLocaleString();
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.author}</td>
            <td>
              <div class="color-box" style="background-color: ${item.color};"></div>
              <span>${item.color}</span>
            </td>
            <td>
              <strong>${category.name}</strong><br>
              <span style="font-size: 0.85em; color: #666;">
                Âêå„ÅòËâ≤„ÇíÈÅ∏„Çì„Å†‰∫∫: ${sameColorCount}‰∫∫
              </span>
            </td> 
            <td>${item.comment || ''}</td>
            <td style="font-size: 0.8em; color: gray;">${date}</td>
          `;
          tbody.appendChild(tr);
        });

        // 4. „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫
        const rankingList = document.getElementById('rankingList');
        rankingList.innerHTML = '';
        const total = list.length || 1;
        const sortedCategories = Object.values(CATEGORIES)
          .map(name => ({ name, count: counts[name], css: CATEGORY_CSS[name] }))
          .sort((a, b) => b.count - a.count);

        sortedCategories.forEach(cat => {
          if (cat.count === 0) return;
          const percent = (cat.count / total) * 100;
          const div = document.createElement('div');
          div.className = 'rank-row';
          div.innerHTML = `
            <div class="rank-label">${cat.name}</div>
            <div class="rank-bar-bg">
              <div class="rank-bar" style="width: ${percent}%; background-color: ${cat.css};"></div>
            </div>
            <div class="rank-count">${cat.count}Á•®</div>
          `;
          rankingList.appendChild(div);
        });
      }
    });
  </script>
</body>
</html>