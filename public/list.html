<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã¿ã‚“ãªã®å¥½ããªè‰²</title>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css" />
    <style>
      /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾ */
      body {
        padding: 20px;
        font-family: sans-serif;
        max-width: 800px;
        margin: 0 auto;
      }
      .ranking-area {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
      }
      .rank-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }
      .rank-label {
        width: 80px;
        font-weight: bold;
      }
      .rank-bar-bg {
        flex-grow: 1;
        background-color: #ddd;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin-right: 10px;
      }
      .rank-bar {
        height: 100%;
        text-align: right;
        padding-right: 5px;
        color: white;
        font-size: 12px;
        line-height: 20px;
        transition: width 0.5s;
      }
      .rank-count {
        width: 40px;
        text-align: right;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
        vertical-align: middle;
      }
      th {
        background-color: #f0f0f0;
      }
      .color-box {
        width: 30px;
        height: 30px;
        border: 1px solid #999;
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
        border-radius: 4px;
      }

      /* è¿½åŠ ï¼šã‚½ãƒ¼ãƒˆç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
      .controls {
        margin: 20px 0;
        padding: 10px;
        background: #eee;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      /* ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿è¿½åŠ  */
      .fav-btn {
        cursor: pointer;
        border: none;
        background: none;
        font-size: 1.5rem;
        color: #ccc;
        padding: 0;
        transition: 0.2s;
      }
      .fav-btn.active {
        color: #f39c12; /* ãŠæ°—ã«å…¥ã‚Šæ™‚ã¯ã‚ªãƒ¬ãƒ³ã‚¸è‰² */
      }
    </style>
  </head>
  <body>
    <h1>ã¿ã‚“ãªã®å¥½ããªè‰²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
    <p>
      <a href="index.html">â† å…¥åŠ›ç”»é¢ã«æˆ»ã‚‹</a>
      <a href="mypage.html" style="margin-left: 15px; text-decoration: none">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸</a>
    </p>

    <div class="ranking-area">
      <h2>ğŸ¨ è‰²ç³»çµ±åˆ¥ äººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <div id="rankingList">é›†è¨ˆä¸­...</div>
    </div>

    <h2>ã™ã¹ã¦ã®å›ç­”ä¸€è¦§</h2>

    <div class="controls">
      <label for="sortSelect">ä¸¦ã³æ›¿ãˆï¼š</label>
      <select id="sortSelect">
        <option value="newest">æ–°ã—ã„é †ï¼ˆæŠ•ç¨¿é †ï¼‰</option>
        <option value="author">ãƒ¦ãƒ¼ã‚¶ãƒ¼åé †</option>
        <option value="category">è‰²ç³»çµ±é †</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
          <th>å¥½ããªè‰²</th>
          <th>åˆ¤å®š</th>
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
          <th>æ—¥æ™‚</th>
          <th>ä¿å­˜</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>

    <script>
      // 1. åŸºæœ¬è¨­å®š (æ—¢å­˜ã®é€šã‚Š)
      const CATEGORIES = {
        RED: 'èµ¤ç³»',
        ORANGE: 'ã‚ªãƒ¬ãƒ³ã‚¸ç³»',
        YELLOW: 'é»„è‰²ç³»',
        GREEN: 'ç·‘ç³»',
        CYAN: 'æ°´è‰²ç³»',
        BLUE: 'é’ç³»',
        PURPLE: 'ç´«ç³»',
        PINK: 'ãƒ”ãƒ³ã‚¯ç³»',
        BROWN: 'èŒ¶è‰²ç³»',
        GRAY: 'ç™½ãƒ»ã‚°ãƒ¬ãƒ¼ç³»',
        BLACK: 'é»’ç³»'
      };

      const CATEGORY_CSS = {
        [CATEGORIES.RED]: '#ff4d4d',
        [CATEGORIES.ORANGE]: '#ffa500',
        [CATEGORIES.YELLOW]: '#ffd700',
        [CATEGORIES.GREEN]: '#4caf50',
        [CATEGORIES.CYAN]: '#00bcd4',
        [CATEGORIES.BLUE]: '#2196f3',
        [CATEGORIES.PURPLE]: '#9c27b0',
        [CATEGORIES.PINK]: '#e91e63',
        [CATEGORIES.BROWN]: '#795548',
        [CATEGORIES.GRAY]: '#9e9e9e',
        [CATEGORIES.BLACK]: '#333333'
      };

      function getColorCategory(hex) {
        hex = hex.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16) / 255;
        const g = parseInt(hex.substring(2, 4), 16) / 255;
        const b = parseInt(hex.substring(4, 6), 16) / 255;
        const max = Math.max(r, g, b),
          min = Math.min(r, g, b);
        const v = max,
          d = max - min;
        const s = max === 0 ? 0 : d / max;
        let h = 0;
        if (max !== min) {
          switch (max) {
            case r:
              h = (g - b) / d + (g < b ? 6 : 0);
              break;
            case g:
              h = (b - r) / d + 2;
              break;
            case b:
              h = (r - g) / d + 4;
              break;
          }
          h /= 6;
        }
        const hDeg = h * 360,
          sPct = s * 100,
          vPct = v * 100;
        if (vPct < 35) return { name: CATEGORIES.BLACK, css: CATEGORY_CSS[CATEGORIES.BLACK] };
        if (sPct < 15) return { name: CATEGORIES.GRAY, css: CATEGORY_CSS[CATEGORIES.GRAY] };
        if (hDeg >= 10 && hDeg < 45 && vPct < 50)
          return { name: CATEGORIES.BROWN, css: CATEGORY_CSS[CATEGORIES.BROWN] };
        let name = '';
        if (hDeg < 20 || hDeg >= 355) name = CATEGORIES.RED;
        else if (hDeg < 45) name = CATEGORIES.ORANGE;
        else if (hDeg < 70) name = CATEGORIES.YELLOW;
        else if (hDeg < 160) name = CATEGORIES.GREEN;
        else if (hDeg < 200) name = CATEGORIES.CYAN;
        else if (hDeg < 260) name = CATEGORIES.BLUE;
        else if (hDeg < 300) name = CATEGORIES.PURPLE;
        else name = CATEGORIES.PINK;
        return { name, css: CATEGORY_CSS[name] };
      }

      // --- ã“ã“ã‹ã‚‰ãŒå¤‰æ›´ãƒ»è¿½åŠ éƒ¨åˆ† ---

      let allRecords = []; // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
      let hexCounts = {}; // åŒã˜è‰²ã®ã‚«ã‚¦ãƒ³ãƒˆç”¨

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»ã™ã‚‹é–¢æ•°
      function renderTable(data) {
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = '';

        data.forEach((item) => {
          const category = getColorCategory(item.color);
          const totalSameColor = hexCounts[item.color.toUpperCase()] || 0;
          const otherPeopleCount = totalSameColor - 1;
          const date = new Date(item.createdAt).toLocaleString();

          const tr = document.createElement('tr');
          tr.innerHTML = `
          <td>${item.author}</td>
          <td>
            <div class="color-box" style="background-color: ${item.color};"></div>
            <span>${item.color}</span>
          </td>
          <td>
            <strong>${category.name}</strong><br>
            <span style="font-size: 0.85em; color: #666;">
              ${otherPeopleCount > 0 ? `ä»–ã«åŒã˜è‰²ã‚’é¸ã‚“ã äºº: ${otherPeopleCount}äºº` : 'åŒã˜è‰²ã‚’é¸ã‚“ã äººã¯ä»–ã«ã„ã¾ã›ã‚“'}
            </span>
          </td> 
          <td>${item.comment || ''}</td>
          <td style="font-size: 0.8em; color: gray;">${date}</td>
          <td>
            <button class="fav-btn ${item.isFavorite ? 'active' : ''}" onclick="toggleFav('${item.id}', this)">
              <i class="uil uil-bookmark-full"></i>
            </button>
          </td>
        `;
          tbody.appendChild(tr);
        });
      }

      // ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã®é€šä¿¡ç”¨é–¢æ•°
      async function toggleFav(id, btn) {
        const res = await fetch(`/api/favorites/${id}`, { method: 'POST' });
        if (res.ok) {
          btn.classList.toggle('active');
        }
      }

      // ã‚½ãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
      function sortData(criteria) {
        let sorted = [...allRecords]; // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’å£Šã•ãªã„ã‚ˆã†ã«ã‚³ãƒ”ãƒ¼

        if (criteria === 'newest') {
          // æŠ•ç¨¿æ—¥æ™‚(createdAt)ã®é™é †
          sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        } else if (criteria === 'author') {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼å(author)ã®æ˜‡é †
          sorted.sort((a, b) => a.author.localeCompare(b.author, 'ja'));
        } else if (criteria === 'category') {
          // è‰²ç³»çµ±å(category.name)ã®æ˜‡é †
          sorted.sort((a, b) => {
            const catA = getColorCategory(a.color).name;
            const catB = getColorCategory(b.color).name;
            return catA.localeCompare(catB, 'ja');
          });
        }

        renderTable(sorted);
      }

      // åˆæœŸåŒ–å‡¦ç†
      document.addEventListener('DOMContentLoaded', async () => {
        const checkRes = await fetch('/api/check');
        if (!checkRes.ok) {
          location.href = 'login.html';
          return;
        }

        const res = await fetch('/api/colors');
        if (res.ok) {
          allRecords = await res.json();

          // ã‚«ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆé›†è¨ˆ
          hexCounts = {};
          allRecords.forEach((item) => {
            const hex = item.color.toUpperCase();
            hexCounts[hex] = (hexCounts[hex] || 0) + 1;
          });

          // ç³»çµ±åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æç”» (ã“ã‚Œã¯1å›ã ã‘ã§OK)
          renderRanking(allRecords);

          // åˆæœŸè¡¨ç¤ºï¼ˆæ–°ã—ã„é †ï¼‰
          sortData('newest');
        }
      });

      // ã‚½ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('sortSelect').addEventListener('change', (e) => {
        sortData(e.target.value);
      });

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æç”»ç”¨ã®é–¢æ•° (æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢)
      function renderRanking(list) {
        const counts = {};
        Object.values(CATEGORIES).forEach((name) => (counts[name] = 0));

        list.forEach((item) => {
          const category = getColorCategory(item.color);
          if (counts[category.name] !== undefined) counts[category.name]++;
        });

        const rankingList = document.getElementById('rankingList');
        rankingList.innerHTML = '';
        const total = list.length || 1;
        const sortedCategories = Object.values(CATEGORIES)
          .map((name) => ({ name, count: counts[name], css: CATEGORY_CSS[name] }))
          .sort((a, b) => b.count - a.count);

        sortedCategories.forEach((cat) => {
          if (cat.count === 0) return;
          const percent = (cat.count / total) * 100;
          const div = document.createElement('div');
          div.className = 'rank-row';
          div.innerHTML = `
          <div class="rank-label">${cat.name}</div>
          <div class="rank-bar-bg">
            <div class="rank-bar" style="width: ${percent}%; background-color: ${cat.css};"></div>
          </div>
          <div class="rank-count">${cat.count}ç¥¨</div>
        `;
          rankingList.appendChild(div);
        });
      }
    </script>
  </body>
</html>
