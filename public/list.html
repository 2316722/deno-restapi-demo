<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>みんなの好きな色</title>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css" />
    <style>
      body {
        padding: 20px;
        font-family: sans-serif;
        max-width: 900px;
        margin: 0 auto;
        background-color: #f0f2f5;
      }
      .nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .ranking-area {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .rank-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }
      .rank-label {
        width: 100px;
        font-weight: bold;
        font-size: 14px;
      }
      .rank-bar-bg {
        flex-grow: 1;
        background-color: #eee;
        height: 18px;
        border-radius: 9px;
        overflow: hidden;
        margin-right: 10px;
      }
      .rank-bar {
        height: 100%;
        transition: width 0.5s;
      }
      .rank-count {
        width: 50px;
        text-align: right;
        font-size: 14px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        background-color: #f8f9fa;
      }
      .color-box {
        width: 24px;
        height: 24px;
        border: 1px solid #ddd;
        display: inline-block;
        vertical-align: middle;
        border-radius: 4px;
        margin-right: 8px;
      }
      .controls {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* Unicons 用スタイル */
      .fav-btn {
        cursor: pointer;
        border: none;
        background: none;
        font-size: 1.5rem;
        color: #ccc;
        transition: 0.2s;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .fav-btn.active {
        color: #f39c12;
      } /* お気に入り時はオレンジ色に */
      .fav-btn:hover {
        transform: scale(1.1);
      }

      .mypage-link {
        background: #333;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="nav-header">
      <a href="index.html">← 入力画面</a>
      <a href="mypage.html" class="mypage-link"><i class="uil uil-user"></i> マイページへ</a>
    </div>

    <div class="ranking-area">
      <h2><i class="uil uil-palette"></i> 色系統別 人気ランキング</h2>
      <div id="rankingList">集計中...</div>
    </div>

    <h2>すべての回答一覧</h2>
    <div class="controls">
      <label for="sortSelect">並び替え：</label>
      <select id="sortSelect">
        <option value="newest">新しい順</option>
        <option value="author">ユーザー名順</option>
        <option value="category">色系統順</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>ユーザー</th>
          <th>好きな色</th>
          <th>判定</th>
          <th>コメント</th>
          <th>日時</th>
          <th>保存</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>

    <script>
      const CATEGORIES = {
        RED: '赤系',
        ORANGE: 'オレンジ系',
        YELLOW: '黄色系',
        GREEN: '緑系',
        CYAN: '水色系',
        BLUE: '青系',
        PURPLE: '紫系',
        PINK: 'ピンク系',
        BROWN: '茶色系',
        GRAY: '白・グレー系',
        BLACK: '黒系'
      };
      const CATEGORY_CSS = {
        赤系: '#ff4d4d',
        オレンジ系: '#ffa500',
        黄色系: '#ffd700',
        緑系: '#4caf50',
        水色系: '#00bcd4',
        青系: '#2196f3',
        紫系: '#9c27b0',
        ピンク系: '#e91e63',
        茶色系: '#795548',
        '白・グレー系': '#9e9e9e',
        黒系: '#333333'
      };

      function getColorCategory(hex) {
        hex = hex.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16) / 255,
          g = parseInt(hex.substring(2, 4), 16) / 255,
          b = parseInt(hex.substring(4, 6), 16) / 255;
        const max = Math.max(r, g, b),
          min = Math.min(r, g, b),
          v = max,
          d = max - min,
          s = max === 0 ? 0 : d / max;
        let h = 0;
        if (max !== min) {
          if (max === r) h = (g - b) / d + (g < b ? 6 : 0);
          else if (max === g) h = (b - r) / d + 2;
          else h = (r - g) / d + 4;
          h /= 6;
        }
        const hDeg = h * 360,
          sPct = s * 100,
          vPct = v * 100;
        if (vPct < 25) return { name: CATEGORIES.BLACK, css: CATEGORY_CSS[CATEGORIES.BLACK] };
        if (sPct < 12) return { name: CATEGORIES.GRAY, css: CATEGORY_CSS[CATEGORIES.GRAY] };
        if (hDeg >= 10 && hDeg < 45 && vPct < 50)
          return { name: CATEGORIES.BROWN, css: CATEGORY_CSS[CATEGORIES.BROWN] };
        let name = '';
        if (hDeg < 20 || hDeg >= 355) name = CATEGORIES.RED;
        else if (hDeg < 45) name = CATEGORIES.ORANGE;
        else if (hDeg < 70) name = CATEGORIES.YELLOW;
        else if (hDeg < 160) name = CATEGORIES.GREEN;
        else if (hDeg < 200) name = CATEGORIES.CYAN;
        else if (hDeg < 260) name = CATEGORIES.BLUE;
        else if (hDeg < 300) name = CATEGORIES.PURPLE;
        else name = CATEGORIES.PINK;
        return { name, css: CATEGORY_CSS[name] };
      }

      let allRecords = [];
      let hexCounts = {};

      async function load() {
        const check = await fetch('/api/check');
        if (!check.ok) {
          location.href = 'login.html';
          return;
        }
        const res = await fetch('/api/colors');
        if (res.ok) {
          allRecords = await res.json();
          hexCounts = {};
          allRecords.forEach((r) => {
            const h = r.color.toUpperCase();
            hexCounts[h] = (hexCounts[h] || 0) + 1;
          });
          renderRanking(allRecords);
          sortData('newest');
        }
      }

      function renderTable(data) {
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = data
          .map((item) => {
            const cat = getColorCategory(item.color);
            const others = (hexCounts[item.color.toUpperCase()] || 0) - 1;
            return `
          <tr>
            <td>${item.author}</td>
            <td><div class="color-box" style="background:${item.color}"></div>${item.color}</td>
            <td><strong>${cat.name}</strong><br><small style="color:gray">${
              others > 0 ? `他 ${others}人` : '唯一の色'
            }</small></td>
            <td>${item.comment || ''}</td>
            <td><small>${new Date(item.createdAt).toLocaleString()}</small></td>
            <td><button class="fav-btn ${item.isFavorite ? 'active' : ''}" onclick="toggleFav('${item.id}', this)">
              <i class="uil uil-bookmark-full"></i>
            </button></td>
          </tr>`;
          })
          .join('');
      }

      async function toggleFav(id, btn) {
        const res = await fetch(`/api/favorites/${id}`, { method: 'POST' });
        if (res.ok) btn.classList.toggle('active');
      }

      function sortData(criteria) {
        let sorted = [...allRecords];
        if (criteria === 'author') sorted.sort((a, b) => a.author.localeCompare(b.author, 'ja'));
        else if (criteria === 'category')
          sorted.sort((a, b) => getColorCategory(a.color).name.localeCompare(getColorCategory(b.color).name, 'ja'));
        else sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        renderTable(sorted);
      }

      function renderRanking(list) {
        const counts = {};
        Object.values(CATEGORIES).forEach((n) => (counts[n] = 0));
        list.forEach((item) => {
          const cat = getColorCategory(item.color);
          counts[cat.name]++;
        });
        const sorted = Object.values(CATEGORIES)
          .map((name) => ({ name, count: counts[name], css: CATEGORY_CSS[name] }))
          .sort((a, b) => b.count - a.count);
        const total = list.length || 1;
        document.getElementById('rankingList').innerHTML = sorted
          .filter((c) => c.count > 0)
          .map(
            (c) => `
        <div class="rank-row">
          <div class="rank-label">${c.name}</div>
          <div class="rank-bar-bg"><div class="rank-bar" style="width:${(c.count / total) * 100}%; background:${
              c.css
            }"></div></div>
          <div class="rank-count">${c.count}票</div>
        </div>`
          )
          .join('');
      }

      document.getElementById('sortSelect').addEventListener('change', (e) => sortData(e.target.value));
      load();
    </script>
  </body>
</html>
