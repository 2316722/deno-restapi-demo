<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã¿ã‚“ãªã®å¥½ããªè‰²</title>
    <style>
      body {
        padding: 20px;
        font-family: sans-serif;
        max-width: 800px;
        margin: 0 auto;
        background-color: #f0f2f5;
      }
      .nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .ranking-area {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .rank-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }
      .rank-label {
        width: 100px;
        font-weight: bold;
        font-size: 14px;
      }
      .rank-bar-bg {
        flex-grow: 1;
        background-color: #eee;
        height: 18px;
        border-radius: 9px;
        overflow: hidden;
        margin-right: 10px;
      }
      .rank-bar {
        height: 100%;
        transition: width 0.5s;
      }
      .rank-count {
        width: 50px;
        text-align: right;
        font-size: 14px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        background-color: #f8f9fa;
      }
      .color-box {
        width: 24px;
        height: 24px;
        border: 1px solid #ddd;
        display: inline-block;
        vertical-align: middle;
        border-radius: 4px;
        margin-right: 8px;
      }
      .controls {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .fav-btn {
        cursor: pointer;
        border: none;
        background: none;
        font-size: 1.2rem;
        filter: grayscale(1);
        transition: transform 0.2s;
      }
      .fav-btn.active {
        filter: grayscale(0);
      }
      .fav-btn:hover {
        transform: scale(1.2);
      }
      .mypage-link {
        background: #333;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="nav-header">
      <a href="index.html">â† å…¥åŠ›ç”»é¢</a>
      <a href="mypage.html" class="mypage-link">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸</a>
    </div>

    <div class="ranking-area">
      <h2>ğŸ¨ è‰²ç³»çµ±åˆ¥ äººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <div id="rankingList">é›†è¨ˆä¸­...</div>
    </div>

    <h2>ã™ã¹ã¦ã®å›ç­”ä¸€è¦§</h2>
    <div class="controls">
      <label for="sortSelect">ä¸¦ã³æ›¿ãˆï¼š</label>
      <select id="sortSelect">
        <option value="newest">æ–°ã—ã„é †</option>
        <option value="author">ãƒ¦ãƒ¼ã‚¶ãƒ¼åé †</option>
        <option value="category">è‰²ç³»çµ±é †</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>ğŸ”–</th>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
          <th>å¥½ããªè‰²</th>
          <th>åˆ¤å®š</th>
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
          <th>æ—¥æ™‚</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>

    <script>
      const CATEGORIES = {
        RED: 'èµ¤ç³»',
        ORANGE: 'ã‚ªãƒ¬ãƒ³ã‚¸ç³»',
        YELLOW: 'é»„è‰²ç³»',
        GREEN: 'ç·‘ç³»',
        CYAN: 'æ°´è‰²ç³»',
        BLUE: 'é’ç³»',
        PURPLE: 'ç´«ç³»',
        PINK: 'ãƒ”ãƒ³ã‚¯ç³»',
        BROWN: 'èŒ¶è‰²ç³»',
        GRAY: 'ç™½ãƒ»ã‚°ãƒ¬ãƒ¼ç³»',
        BLACK: 'é»’ç³»'
      };
      const CATEGORY_CSS = {
        èµ¤ç³»: '#ff4d4d',
        ã‚ªãƒ¬ãƒ³ã‚¸ç³»: '#ffa500',
        é»„è‰²ç³»: '#ffd700',
        ç·‘ç³»: '#4caf50',
        æ°´è‰²ç³»: '#00bcd4',
        é’ç³»: '#2196f3',
        ç´«ç³»: '#9c27b0',
        ãƒ”ãƒ³ã‚¯ç³»: '#e91e63',
        èŒ¶è‰²ç³»: '#795548',
        'ç™½ãƒ»ã‚°ãƒ¬ãƒ¼ç³»': '#9e9e9e',
        é»’ç³»: '#333333'
      };

      function getColorCategory(hex) {
        hex = hex.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16) / 255,
          g = parseInt(hex.substring(2, 4), 16) / 255,
          b = parseInt(hex.substring(4, 6), 16) / 255;
        const max = Math.max(r, g, b),
          min = Math.min(r, g, b),
          v = max,
          d = max - min,
          s = max === 0 ? 0 : d / max;
        let h = 0;
        if (max !== min) {
          if (max === r) h = (g - b) / d + (g < b ? 6 : 0);
          else if (max === g) h = (b - r) / d + 2;
          else h = (r - g) / d + 4;
          h /= 6;
        }
        const hDeg = h * 360,
          sPct = s * 100,
          vPct = v * 100;
        if (vPct < 25) return { name: CATEGORIES.BLACK, css: CATEGORY_CSS[CATEGORIES.BLACK] };
        if (sPct < 12) return { name: CATEGORIES.GRAY, css: CATEGORY_CSS[CATEGORIES.GRAY] };
        if (hDeg >= 10 && hDeg < 45 && vPct < 50)
          return { name: CATEGORIES.BROWN, css: CATEGORY_CSS[CATEGORIES.BROWN] };
        let name = '';
        if (hDeg < 20 || hDeg >= 355) name = CATEGORIES.RED;
        else if (hDeg < 45) name = CATEGORIES.ORANGE;
        else if (hDeg < 70) name = CATEGORIES.YELLOW;
        else if (hDeg < 160) name = CATEGORIES.GREEN;
        else if (hDeg < 200) name = CATEGORIES.CYAN;
        else if (hDeg < 260) name = CATEGORIES.BLUE;
        else if (hDeg < 300) name = CATEGORIES.PURPLE;
        else name = CATEGORIES.PINK;
        return { name, css: CATEGORY_CSS[name] };
      }

      let allRecords = [];
      let hexCounts = {};

      async function load() {
        const check = await fetch('/api/check');
        if (!check.ok) {
          location.href = 'login.html';
          return;
        }
        const res = await fetch('/api/colors');
        if (res.ok) {
          allRecords = await res.json();
          hexCounts = {};
          allRecords.forEach((r) => {
            const h = r.color.toUpperCase();
            hexCounts[h] = (hexCounts[h] || 0) + 1;
          });
          renderRanking(allRecords);
          sortData('newest');
        }
      }

      function renderTable(data) {
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = data
          .map((item) => {
            const cat = getColorCategory(item.color);
            const others = (hexCounts[item.color.toUpperCase()] || 0) - 1;
            return `
          <tr>
            <td><button class="fav-btn ${item.isFavorite ? 'active' : ''}" onclick="toggleFav('${
              item.id
            }', this)">ğŸ”–</button></td>
            <td>${item.author}</td>
            <td><div class="color-box" style="background:${item.color}"></div>${item.color}</td>
            <td><strong>${cat.name}</strong><br><small style="color:gray">${
              others > 0 ? `ä»– ${others}äºº` : 'å”¯ä¸€ã®è‰²'
            }</small></td>
            <td>${item.comment || ''}</td>
            <td><small>${new Date(item.createdAt).toLocaleString()}</small></td>
          </tr>`;
          })
          .join('');
      }

      async function toggleFav(id, btn) {
        const res = await fetch(`/api/favorites/${id}`, { method: 'POST' });
        if (res.ok) btn.classList.toggle('active');
      }

      function sortData(criteria) {
        let sorted = [...allRecords];
        if (criteria === 'author') sorted.sort((a, b) => a.author.localeCompare(b.author, 'ja'));
        else if (criteria === 'category')
          sorted.sort((a, b) => getColorCategory(a.color).name.localeCompare(getColorCategory(b.color).name, 'ja'));
        else sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        renderTable(sorted);
      }

      function renderRanking(list) {
        const counts = {};
        Object.values(CATEGORIES).forEach((n) => (counts[n] = 0));
        list.forEach((item) => {
          const cat = getColorCategory(item.color);
          counts[cat.name]++;
        });
        const sorted = Object.values(CATEGORIES)
          .map((name) => ({ name, count: counts[name], css: CATEGORY_CSS[name] }))
          .sort((a, b) => b.count - a.count);
        const total = list.length || 1;
        document.getElementById('rankingList').innerHTML = sorted
          .filter((c) => c.count > 0)
          .map(
            (c) => `
        <div class="rank-row">
          <div class="rank-label">${c.name}</div>
          <div class="rank-bar-bg"><div class="rank-bar" style="width:${(c.count / total) * 100}%; background:${
              c.css
            }"></div></div>
          <div class="rank-count">${c.count}ç¥¨</div>
        </div>`
          )
          .join('');
      }

      document.getElementById('sortSelect').addEventListener('change', (e) => sortData(e.target.value));
      load();
    </script>
  </body>
</html>
